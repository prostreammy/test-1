<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sooka DASH Stream Player (Shaka - Debug)</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #282c34; color: white; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .main-container { width: 100%; max-width: 1000px; }
        .video-container { width: 100%; aspect-ratio: 16 / 9; background-color: #000; box-shadow: 0 0 20px rgba(0,0,0,0.5); margin-bottom: 20px; }
        video { width: 100%; height: 100%; }
        .debug-container { background-color: #1c1e26; border: 1px solid #444; border-radius: 5px; padding: 15px; font-family: 'Courier New', Courier, monospace; font-size: 0.9em; color: #ccc; max-height: 250px; overflow-y: auto; }
        .debug-log { margin: 0; padding: 2px 0; }
        .debug-log.info { color: #61dafb; }
        .debug-log.error { color: #ff6b6b; font-weight: bold; }
        .debug-log.success { color: #51cf66; }
        .debug-log.warn { color: #ffd43b; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="video-container">
            <video id="videoPlayer" controls></video>
        </div>
        <div class="debug-container">
            <h3 style="margin-top:0;">Debug Status</h3>
            <div id="debugLog"></div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/shaka-player@latest/dist/shaka-player.ui.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shaka-player@latest/dist/controls.css">
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const debugLog = document.getElementById('debugLog');
            function log(message, type = 'info') {
                const logEntry = document.createElement('p');
                logEntry.className = `debug-log ${type}`;
                logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                debugLog.appendChild(logEntry);
                debugLog.scrollTop = debugLog.scrollHeight;
                console.log(message);
            }

            const mpdUrl = 'https://l01.dp.sooka.my/5099/linear/index.mpd';
            const authToken = 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE3NjM0MzQ5NzIsImlzcyI6IlZSIiwiZXhwIjoxNzYzNTA1MDAwLCJ3bXZlciI6Mywid21pZGZtdCI6ImFzY2lpIiwid21pZHR5cCI6MSwid21rZXl2ZXIiOjMsIndtdG1pZHZlciI6NCwid21pZGxlbiI6NTEyLCJ3bW9waWQiOjMyLCJ3bWlkIjoiMTE1ZTY0NmMtYjI4ZC00N2Q0LTk2OWMtYmNmMzllMTliM2FjIiwiZmlsdGVyIjoiKHR5cGU9PVwidmlkZW9cIiYmRGlzcGxheUhlaWdodDw9MjE2MCl8fCh0eXBlPT1cImF1ZGlvXCImJmZvdXJDQyE9XCJhYy0zXCIpfHwodHlwZSE9XCJ2aWRlb1wiJiZ0eXBlIT1cImF1ZGlvXCIpIiwicGF0dGVybiI6IjUwOTkifQ.9uM4UXEEZ4eOtzm8sNDoiZ3Kx0jRuk9WasT1uQtxQDo';

            const videoElement = document.getElementById('videoPlayer');

            try {
                log('Initializing Shaka Player...');
                if (!shaka.Player.isBrowserSupported()) throw new Error('Browser does not support Shaka Player.');
                const player = new shaka.Player(videoElement);
                log('Shaka Player instance created.');

                // Configure networking for retries and timeouts
                player.configure('streaming.retryParameters', {
                    timeout: 0, /* ms; 0 = infinity */
                    maxAttempts: 5,
                    baseDelay: 1000, /* ms */
                    backoffFactor: 2,
                    fuzzFactor: 0.5
                });
                log('Retry parameters configured.');


                player.getNetworkingEngine().registerRequestFilter((type, request) => {
                    if (type === shaka.net.NetworkingEngine.RequestType.MANIFEST || type === shaka.net.NetworkingEngine.RequestType.SEGMENT) {
                        request.headers['Authorization'] = authToken;
                        request.headers['Origin'] = 'https://sooka.my';
                        request.headers['Referer'] = 'https://sooka.my/';
                    }
                });
                log('Request filter registered.');

                player.addEventListener('error', (errorEvent) => {
                    const error = errorEvent.detail;
                    let errorMessage = `Player Error: ${error.code} - ${error.message}`;
                    
                    // Get more detail for HTTP errors
                    if (error.code === shaka.util.Error.Code.HTTP_ERROR) {
                        const statusCode = error.data[1]; // The HTTP status code is the second element in the data array
                        errorMessage += ` (HTTP ${statusCode})`;
                        if (statusCode === 401) {
                            errorMessage += ' -> This usually means the token has expired.';
                        } else if (statusCode === 403) {
                            errorMessage += ' -> This might mean the Origin/Referer is blocked.';
                        } else if (statusCode === 404) {
                            errorMessage += ' -> The requested segment was not found on the server.';
                        }
                    }
                    log(errorMessage, 'error');
                });

                log(`Attempting to load stream: ${mpdUrl}`);
                await player.load(mpdUrl);
                log('Stream loaded successfully!', 'success');

            } catch (error) {
                log(`Failed to start player: ${error.message}`, 'error');
                videoElement.style.display = 'none';
            }
        });
    </script>
</body>
</html>
