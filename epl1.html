<!DOCTYPE html>
<html lang="en">
<head>
    <title>PROSTREAM-EPL1(VIP)</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Google Fonts for a professional watermark font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@700&display=swap" rel="stylesheet">

    <!-- Shaka Player UI compiled library -->
    <script src="https://ajax.googleapis.com/ajax/libs/shaka-player/4.11.9/shaka-player.ui.js"></script>
    <!-- Shaka Player UI compiled library default CSS -->
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/shaka-player/4.11.9/controls.css">
    <!-- Chromecast SDK -->
    <script defer src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            overflow: hidden;
        }

        [data-shaka-player-container] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        #watermark {
            position: absolute;
            top: 2vw;
            left: 2vw;
            z-index: 9999;
            font-family: 'Roboto', sans-serif;
            font-size: 3.5vw;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.6);
            pointer-events: none;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.9);
            letter-spacing: 2px;
        }

        [data-shaka-player-container] *:focus {
            outline: 2px solid #ffcc00 !important;
            background-color: rgba(255, 204, 0, 0.2) !important;
        }
        
        [data-shaka-player-container] button {
             -webkit-appearance: none;
        }

        /* 
         * --- NEW: Style for our Custom Caption Display ---
        */
        #custom-captions {
            position: absolute !important;
            bottom: 15% !important; /* 15% from the bottom */
            left: 50% !important;
            transform: translateX(-50%) !important;
            width: 70% !important;
            text-align: center !important;
            z-index: 10 !important;
            font-family: Arial, sans-serif;
            color: white;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 0.2em 0.5em;
            border-radius: 0.2em;
            font-size: 2.5vh;
            line-height: 1.4;

            /* Clamp to 2 lines */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            pointer-events: none; /* Ensure captions don't block clicks */
        }
    </style>
</head>
<body>

    <div data-shaka-player-container>
        <video data-shaka-player id="video"></video>
        <div id="watermark">PROSTREAM-EPL1</div>
        <!-- NEW: Our custom caption container -->
        <div id="custom-captions"></div>
    </div>

    <script>
        const manifestUri = 'https://fsly.stream.peacocktv.com/Content/CMAF_CTR-4s/Live/channel(vc1021n07j)/master.mpd';

        // --- NEW: Global variables for our caption sync engine ---
        let captionOffset = 0; // The sync offset in seconds
        let currentTextTrack = null;
        let syncInterval = null;

        const customCaptionsDiv = document.getElementById('custom-captions');

        // --- NEW: Our manual caption sync function ---
        function checkCaptionSync() {
            if (!window.player || !currentTextTrack) return;

            const video = document.getElementById('video');
            const currentTime = video.currentTime + captionOffset;
            let activeCue = null;

            // Find the cue that should be active at the current time
            for (const cue of currentTextTrack.cues) {
                if (currentTime >= cue.startTime && currentTime < cue.endTime) {
                    activeCue = cue;
                    break;
                }
            }

            // Update our custom caption display
            customCaptionsDiv.innerText = activeCue ? activeCue.text : '';
        }

        // --- NEW: Functions to adjust caption sync ---
        function adjustCaptionSync(amount) {
            captionOffset += amount;
            console.log(`â±ï¸ Caption offset adjusted to ${captionOffset}s`);
            // Immediately check sync after adjustment
            checkCaptionSync();
        }

        function makeControlsFocusable() {
            console.log('ðŸŽ¯ Making controls focusable...');
            const container = document.querySelector('[data-shaka-player-container]');
            if (!container) return;
            const focusableElements = container.querySelectorAll('button, input, [role="slider"], .shaka-range-container');
            focusableElements.forEach(el => el.setAttribute('tabindex', '0'));
        }

        function ensureFocus() {
            const container = document.querySelector('[data-shaka-player-container]');
            const overflowButton = document.querySelector('.shaka-overflow-menu-button');
            if (container && overflowButton && !container.contains(document.activeElement)) {
                overflowButton.focus();
            }
        }
        
        function unmuteVideo() {
            const video = document.getElementById('video');
            if (video.muted) {
                video.muted = false;
                console.log('ðŸ”Š Video has been unmuted.');
                document.removeEventListener('keydown', unmuteVideo);
            }
        }

        async function init() {
            const video = document.getElementById('video');
            const ui = video['ui'];
            const controls = ui.getControls();
            const player = controls.getPlayer();

            video.muted = true;

            // --- Configure for Low Latency and Disable Default Captions ---
            player.configure({
                streaming: {
                    lowLatencyMode: true,
                    manifest: { presentationTimelineDelay: 5 },
                    bufferBehind: 10,
                },
                // --- KEY: Use a factory that does nothing, effectively disabling Shaka's text display ---
                textDisplayFactory: () => new shaka.text.TextDisplayer(),
                drm: {
                    clearKeys: {
                        '002046c9a49b9ab1cdb6616bec5d26c3': 'd2f92f6b7edc9a1a05d393ba0c20ef9e'
                    }
                }
            });

            // --- NEW: Add custom sync buttons to the overflow menu ---
            ui.configure({
                addSeekBar: false,
                addBigPlayButton: true,
                singleClickForPlayAndPause: false,
                enableTooltips: false,
                doubleClickForFullscreen: false,
                controlPanelElements: ['play_pause', 'skip_previous', 'skip_next', 'spacer', 'overflow_menu', 'fullscreen'],
                overflowMenuButtons: [
                    'captions',
                    'quality',
                    'language',
                    'chapter',
                    'picture_in_picture',
                    'playback_rate',
                    'recenter_vr',
                    'toggle_stereoscopic',
                    // --- NEW: Add our custom sync buttons ---
                    { name: 'sync_plus', label: 'Captions +0.5s', icon: 'add_circle_outline' },
                    { name: 'sync_minus', label: 'Captions -0.5s', icon: 'remove_circle_outline' },
                ],
            });

            window.player = player;
            window.ui = ui;

            player.addEventListener('error', onPlayerErrorEvent);
            controls.addEventListener('error', onUIErrorEvent);
            
            // --- Listen for clicks on our new custom buttons ---
            controls.addEventListener('overflowmenuclick', (event) => {
                if (event.button.name === 'sync_plus') {
                    adjustCaptionSync(0.5);
                } else if (event.button.name === 'sync_minus') {
                    adjustCaptionSync(-0.5);
                }
            });

            player.addEventListener('trackschanged', () => {
                console.log('ðŸŽ¬ Tracks changed, setting up custom captions...');
                const textTracks = player.getTextTracks();
                const captionTrack = textTracks.find(track => track.type === 'text' && track.kind === 'subtitles');

                if (captionTrack) {
                    console.log('ðŸŽ¬ Found caption track:', captionTrack.language);
                    player.selectTextTrack(captionTrack); // Select track to get its cues
                    player.setTextTrackVisibility(false); // But keep Shaka's display hidden
                    currentTextTrack = captionTrack;
                    
                    // Start our sync engine if it's not already running
                    if (!syncInterval) {
                        syncInterval = setInterval(checkCaptionSync, 250); // Check 4 times per second
                    }
                } else {
                    console.log('ðŸŽ¬ No subtitle track found.');
                    currentTextTrack = null;
                    clearInterval(syncInterval);
                    syncInterval = null;
                    customCaptionsDiv.innerText = '';
                }
            });

            video.addEventListener('playing', () => {
                setTimeout(unmuteVideo, 500);
            });

            try {
                await player.load(manifestUri);
                console.log('âœ… The video has now been loaded!');
                await player.play();
                console.log('âœ… Autoplay started.');
            } catch (error) {
                onPlayerError(error);
            }
        }

        function onPlayerErrorEvent(errorEvent) { onPlayerError(event.detail); }
        function onPlayerError(error) { console.error('Error code', error.code, 'object', error); }
        function onUIErrorEvent(errorEvent) { onPlayerError(event.detail); }
        function initFailed(errorEvent) { console.error('âŒ Unable to load the UI library!'); }

        document.addEventListener('shaka-ui-loaded', () => {
            init();
            makeControlsFocusable();
        });

        document.addEventListener('keydown', unmuteVideo);
        document.addEventListener('keydown', (e) => {
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Enter', ' '].includes(e.key)) {
                setTimeout(ensureFocus, 0);
            }
        });

        document.addEventListener('shaka-ui-load-failed', initFailed);
    </script>

</body>
</html>
