<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EPL1 TV Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/shaka-player.ui.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/controls.css">
    <style>
        html, body {
            margin: 0; padding: 0; width: 100vw; height: 100vh;
            background-color: #000; overflow: hidden;
        }
        .video-container { width: 100%; height: 100%; display: flex; background: #000; }
        video { width: 100%; height: 100%; object-fit: contain; }
        
        /* UI Adjustments */
        .shaka-controls-button-panel { font-size: 24px; }
        .shaka-controls-button-panel > button { padding: 12px; margin: 0 8px; }
        .shaka-seek-bar-container { display: none !important; } /* Hide seek bar for live TV */
    </style>
</head>
<body>
    <div class="video-container" data-shaka-player-container>
        <video id="video" data-shaka-player autoplay playsinline muted></video>
    </div>

    <script>
        const PROXY_PATH = '/api/epl1-proxy';
        let player, ui;

        // Auto-Fullscreen Trigger
        function goFullScreen() {
            const container = document.querySelector('[data-shaka-player-container]');
            if (container.requestFullscreen) container.requestFullscreen();
            else if (container.webkitRequestFullscreen) container.webkitRequestFullscreen();
            else if (container.msRequestFullscreen) container.msRequestFullscreen();
            
            // Unmute on first click (browsers block auto-audio)
            const video = document.getElementById('video');
            video.muted = false;
        }

        async function initApp() {
            shaka.polyfill.installAll();
            if (!shaka.Player.isBrowserSupported()) return;

            const video = document.getElementById('video');
            const container = video.parentElement;
            player = new shaka.Player(video);
            ui = new shaka.ui.Overlay(player, container, video);

            // 1. Optimized Player Configuration for speed
            player.configure({
                streaming: {
                    bufferingGoal: 10,       // Reduced from 30 to start faster
                    rebufferingGoal: 2,
                    bufferBehind: 0,
                    lowLatencyMode: true,
                },
                manifest: {
                    dash: { autoCorrectDrift: true, ignoreMinBufferTime: true }
                }
            });

            // 2. UI Config
            ui.configure({
                controlPanelElements: ['play_pause', 'overflow_menu', 'fullscreen'],
                addBigPlayButton: true,
                overflowMenuButtons: ['quality', 'language']
            });

            // 3. Robust Network Filter
            player.getNetworkingEngine().registerRequestFilter((type, request) => {
                if (type === shaka.net.NetworkingEngine.RequestType.MANIFEST) {
                    request.uris = [PROXY_PATH];
                } 
                else if (type === shaka.net.NetworkingEngine.RequestType.SEGMENT) {
                    const originalUri = request.uris[0];
                    // If URI is already a proxy URL, don't wrap it again
                    if (originalUri.includes('segment=')) return;

                    try {
                        const urlObj = new URL(originalUri);
                        const path = urlObj.pathname + urlObj.search;
                        // Extract everything after /mpd/epl1/ to maintain folder structure
                        const segmentPath = path.split('/mpd/epl1/').pop();
                        request.uris = [`${PROXY_PATH}?segment=${encodeURIComponent(segmentPath)}`];
                    } catch (e) {
                        // Fallback for relative paths
                        const fileName = originalUri.substring(originalUri.lastIndexOf('/') + 1);
                        request.uris = [`${PROXY_PATH}?segment=${fileName}`];
                    }
                }
            });

            // 4. Load Stream
            try {
                await player.load(PROXY_PATH);
                console.log('Stream Loaded');
            } catch (e) { console.error('Load Error', e); }
        }

        // Handle Auto-Fullscreen on first interaction
        document.addEventListener('click', goFullScreen, { once: true });
        document.addEventListener('touchstart', goFullScreen, { once: true });
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
